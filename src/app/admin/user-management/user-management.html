<div class="admin-container">
  <app-admin-sidebar></app-admin-sidebar>

  <div class="admin-container">
    <app-admin-sidebar></app-admin-sidebar>
  
    <main class="content">
      <!-- Header -->
      <app-admin-header></app-admin-header>
  
      <div class="header">
        <h1>Khách hàng</h1>
        <p class="subtitle">Chào Tường Vy, mừng bạn đến với trang quản lý chuyến bay!</p>
      </div>

    <div class="main-content-panel">

      <div class="tab-header-row">
        <div class="tabs">
          <button [class.active]="activeTab === 'list'" (click)="switchTab('list')">
            Danh sách Người dùng
          </button>
          <button [class.active]="activeTab === 'form'" (click)="switchTab('form')">
            Cập nhật thông tin
          </button>
        </div>

        <div class="list-toolbar" *ngIf="activeTab === 'list'">
          <div class="search-wrap">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#999">
              <circle cx="11" cy="11" r="8" stroke-width="2"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65" stroke-width="2"></line>
            </svg>
            <input type="text" placeholder="Tìm theo tên, email, SĐT..." [(ngModel)]="searchTerm" />
          </div>
          <div class="filter-wrap">
            <select [(ngModel)]="selectedRank">
              <option value="all">Tất cả Rank</option>
              <option *ngFor="let rank of uniqueRanks" [value]="rank">{{ rank }}</option>
            </select>
          </div>
          <div class="filter-wrap">
            <select [(ngModel)]="selectedStatus">
              <option value="all">Tất cả Trạng thái</option>
              <option *ngFor="let status of uniqueStatuses" [value]="status">{{ status }}</option>
            </select>
          </div>
          <button class="btn btn-add-new" (click)="navigateToAddForm()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            <span>Thêm</span>
          </button>
        </div>
      </div>

      <div *ngIf="activeTab === 'list'" class="list-container">
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Ảnh</th>
                <th>Họ tên / Email</th>
                <th>Rank hiện tại</th>
                <th>Điểm tích lũy</th>
                <th>Trạng thái</th>
                <th>Điện thoại</th>
                <th>Hành động</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngIf="filteredUsers.length === 0">
                <td colspan="7" class="no-data">Không tìm thấy người dùng nào.</td>
              </tr>
              <tr *ngFor="let user of filteredUsers">
                <td class="user-avatar-cell">
                  <img [src]="user.avatar" alt="Avatar" class="user-avatar" />
                </td>
                <td class="user-info-cell">
                  <strong>{{ user.fullName }}</strong>
                  <br>
                  <span class="small-text">{{ user.email }}</span>
                </td>
                <td>{{ user.currentRank }}</td>
                <td>{{ user.points | number }}</td>
                <td [class]="'status-cell ' + (user.status || 'Hoạt động').toLowerCase().replace(' ', '-')">
                    {{ user.status || 'Hoạt động' }}
                </td>
                <td>{{ user.phone }}</td>
                <td class="actions">
                  <button title="Xem chi tiết" class="action-btn view" (click)="viewUser(user)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" stroke-width="1.5"></path>
                      <circle cx="12" cy="12" r="3" stroke-width="1.5"></circle>
                    </svg>
                  </button>
                  <button title="Sửa" class="action-btn edit" (click)="editUser(user)">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" stroke-width="1.5"></path>
                      <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" stroke-width="1.5"></path>
                    </svg>
                  </button>
                  <button title="Xóa" class="action-btn delete" (click)="promptDelete(user.email)">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <polyline points="3 6 5 6 21 6" stroke-width="1.5"></polyline>
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                        stroke-width="1.5"></path>
                    </svg>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div *ngIf="activeTab === 'form'" class="form-container">
        <div class="user-form">
          <div class="form-column">
            <div>
              <label>Họ và Tên</label>
              <input [(ngModel)]="formUser.fullName" type="text" placeholder="Ví dụ: Nguyễn Văn An" />
            </div>
            <div>
              <label>Email</label>
              <input 
                [(ngModel)]="formUser.email" 
                type="email" 
                placeholder="Ví dụ: nguyenvana@gmail.com" 
                [readonly]="!isAddingMode"
                [class.read-only-field]="!isAddingMode"
              />
            </div>
            <div>
              <label>Điện thoại</label>
              <input [(ngModel)]="formUser.phone" type="tel" placeholder="Ví dụ: 0912345678" />
            </div>
            <div>
              <label>Địa chỉ</label>
              <input [(ngModel)]="formUser.address" type="text" placeholder="Ví dụ: 25 Nguyễn Trãi, Q1, TP.HCM" />
            </div>
            <div>
              <label>Giới tính</label>
              <select [(ngModel)]="formUser.gender">
                <option value="Nam">Nam</option>
                <option value="Nữ">Nữ</option>
                <option value="Khác">Khác</option>
              </select>
            </div>
            
            <div>
                <label>Trạng thái</label>
                <input [(ngModel)]="formUser.status" type="text" readonly class="read-only-field" />
            </div>
            
          </div>
          <div class="form-column">
            <div>
              <label>Ngày sinh</label>
              <input [(ngModel)]="formUser.birthday" type="text" placeholder="Định dạng: DD/MM/YYYY" />
            </div>
            <div>
              <label>Hạng thành viên (Rank)</label>
              <input [(ngModel)]="formUser.currentRank" type="text" readonly class="read-only-field" />
            </div>
            <div>
              <label>Điểm tích lũy</label>
              <input [(ngModel)]="formUser.points" type="number" readonly class="read-only-field" />
            </div>
            <div>
              <label>Số căn cước/Hộ chiếu</label>
              <input [(ngModel)]="formUser.passport" type="text" placeholder="Ví dụ: 079123451" />
            </div>
            <div>
              <label>Ngày hết hạn giấy tờ</label>
              <input [(ngModel)]="formUser.passportExpiry" type="text" placeholder="Định dạng: DD/MM/YYYY" />
            </div>
          </div>
        </div>
        
        <div class="form-buttons">
          <button class="btn form-btn-cancel" (click)="cancelForm()">Hủy</button>
          
          <button class="btn form-btn-save" 
            (click)="addUser()"
            [disabled]="isFormInvalid || !isAddingMode">
            Lưu (Thêm mới)
          </button>
          
          <button class="btn form-btn-edit" 
            (click)="updateUser()"
            [disabled]="!formUser.email || isAddingMode || isFormInvalid">
            Chỉnh sửa
          </button>
        </div>
      </div>
    </div>
    <div *ngIf="showDeleteConfirm" class="modal-overlay">
      <div class="modal-content">
        <h4>Xác nhận xóa</h4>
        <p>Bạn có chắc chắn muốn xóa người dùng **{{ userToDeleteEmail }}** không? Hành động này không thể hoàn tác.</p>
        <div class="modal-buttons">
          <button class="btn btn-modal-cancel" (click)="cancelDelete()">Hủy</button>
          <button class="btn btn-modal-delete" (click)="confirmDelete()">Xóa</button>
        </div>
      </div>
    </div>

    <div *ngIf="showViewModal && userToView" class="modal-overlay">
      <div class="modal-content modal-view">
        <h4>Chi tiết Người dùng: {{ userToView.fullName }}</h4>
        <div class="view-details-grid">

          <div class="detail-item"><label>Email</label><span>{{ userToView.email }}</span></div>
          <div class="detail-item"><label>Điện thoại</label><span>{{ userToView.phone }}</span></div>
          <div class="detail-item"><label>Ngày sinh</label><span>{{ userToView.birthday }} ({{ userToView.gender
              }})</span></div>
          <div class="detail-item"><label>Quốc gia</label><span>{{ userToView.country }}</span></div>

          <div class="detail-item"><label>Hạng hiện tại</label><span>**{{ userToView.currentRank }}**</span></div>
          <div class="detail-item"><label>Điểm tích lũy</label><span>{{ userToView.points | number }}</span></div>
          <div class="detail-item"><label>Hạng tiếp theo</label><span>{{ userToView.nextRank }} (Cần: {{
              userToView.nextThreshold | number }} điểm)</span></div>
          <div class="detail-item full-width">
            <label>Địa chỉ</label>
            <span>{{ userToView.address }}</span>
          </div>

          <div class="detail-item"><label>Số căn cước/Hộ chiếu</label><span>{{ userToView.passport }}</span></div>
          <div class="detail-item"><label>Ngày hết hạn</label><span>{{ userToView.passportExpiry }}</span></div>

          <div class="detail-item full-width"><label>Trạng thái</label><span>{{ userToView.status || '(Chưa xác định)'
              }}</span>
          </div>

        </div>
        <div class="modal-buttons">
          <button class="btn btn-modal-close" (click)="closeViewModal()">Đóng</button>
        </div>
      </div>
    </div>
  </main>
</div>